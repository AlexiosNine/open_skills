# 代码审查报告

## 审查范围
- 整体架构和代码结构
- 主流程（请求处理、技能调用）
- 各模块深入分析

## 一、整体结构问题

### 1.1 项目结构
- ✅ 项目结构清晰，模块划分合理
- ⚠️ **缺少统一的错误处理机制** - 各模块错误处理方式不一致
- ⚠️ **缺少依赖注入** - 全局单例模式，不利于测试和扩展
- ⚠️ **缺少配置管理** - 配置分散，应该使用 Pydantic Settings

### 1.2 代码组织
- ✅ 模块职责清晰
- ⚠️ **缺少类型注解** - 部分函数缺少完整的类型注解
- ⚠️ **缺少文档字符串** - 部分类和方法缺少详细的文档

## 二、主流程问题

### 2.1 请求处理流程 (`src/app.py`)

#### 问题点：
1. **Trace ID 管理**
   - `trace_id_ctx` 定义了但未在 middleware 中使用
   - 应该通过 middleware 统一设置 trace_id 到 context

2. **输入验证**
   - 缺少 `skill_id` 格式验证（应只允许字母数字和连字符）
   - 缺少请求大小限制（`request.input` 可能很大）
   - 缺少请求限流（防止滥用）

3. **错误处理**
   - 异常情况下 `result` 可能为 None，缺少检查
   - 全局异常处理器应该从 request 提取 trace_id
   - 生产环境不应暴露详细异常信息

4. **性能优化**
   - `registry` 和 `factory` 每次请求都获取，应该考虑缓存
   - 如果支持热重载，应该检查是否需要重新加载

### 2.2 技能调用流程 (`src/runners/cli_python.py`)

#### 问题点：
1. **安全性**
   - 应该验证 `script_path` 是否在允许的目录内
   - 应该检查脚本文件权限
   - 应该限制输出大小，防止内存问题

2. **资源管理**
   - 应该设置环境变量（PYTHONPATH, PATH）
   - 应该限制子进程的资源使用（内存、CPU）
   - 应该使用进程池限制并发执行的技能数量

3. **错误处理**
   - 应该记录 stderr 到日志（即使成功）
   - 应该验证输出数据的结构
   - 应该对输出数据进行大小限制和清理

## 三、各模块深入分析

### 3.1 配置管理 (`src/config.py`)

#### 问题点：
1. **配置验证**
   - 应该验证 `timeout_ms > 0`
   - 应该验证 URL 格式
   - 应该验证 API key 格式（至少检查长度）

2. **配置管理**
   - 应该使用 Pydantic Settings 提供更好的验证和类型安全
   - 应该支持配置热重载（通过文件监听或信号）
   - 创建目录时应该设置适当的权限（如 0o755）

### 3.2 注册表 (`src/registry.py`)

#### 问题点：
1. **功能增强**
   - 应该支持从环境变量或配置文件指定 `skills_dir`
   - 应该支持监听文件变化自动重载（使用 watchdog）
   - 应该支持递归加载子目录中的 manifests
   - 应该检测重复的 `skill_id` 并警告

2. **验证**
   - 应该验证 `id` 格式（只允许字母数字和连字符）
   - 应该验证 `entry` 路径是否存在且可执行

### 3.3 Agent 模块 (`src/agent/`)

#### 3.3.1 Agent 核心 (`src/agent/agent.py`)

#### 问题点：
1. **存储**
   - 内存存储对话历史，生产环境应该使用持久化存储（Redis/DB）
   - 应该设置对话历史的 TTL 和最大数量限制

2. **循环控制**
   - 应该添加最大迭代时间限制，防止无限循环
   - 应该添加每次迭代的超时控制
   - Token 计算可能不准确，应该使用实际的 API 返回值

3. **验证重试**
   - 应该区分全局重试次数和单个工具的重试次数
   - 应该记录每次验证失败的原因

4. **性能**
   - 应该异步保存对话历史，避免阻塞响应
   - 应该检查对话历史大小，防止内存溢出
   - `max_messages` 应该可配置
   - 应该使用更智能的截断策略（保留系统消息和最近的对话）

#### 3.3.2 Agent API (`src/agent/api.py`)

#### 问题点：
1. **Provider 验证**
   - 应该从配置中动态获取支持的 providers，而不是硬编码
   - 应该验证 provider 是否已配置 API key

2. **线程池**
   - `ThreadPoolExecutor` 应该使用全局实例，避免每次请求创建新的
   - 应该设置线程池的最大工作线程数
   - 应该添加请求超时控制

#### 3.3.3 Tool Manager (`src/agent/tool_manager.py`)

#### 问题点：
1. **缓存管理**
   - `_tool_schemas` 缓存应该在 registry 变化时失效
   - 应该支持工具的动态注册和注销

2. **描述获取**
   - 应该从 `manifest.yaml` 中读取 `description` 字段，而不是硬编码
   - 如果 manifest 中没有，可以尝试从 skill 脚本的 docstring 读取

#### 3.3.4 LLM Client (`src/agent/client.py`)

#### 问题点：
1. **配置**
   - 应该支持 HTTP 代理配置
   - 应该支持请求超时配置
   - 应该支持重试策略配置

2. **错误处理**
   - 应该添加请求重试逻辑（网络错误、5xx 错误等）
   - 应该记录请求和响应的详细信息（用于调试和监控）

### 3.4 中间件 (`src/middleware.py`)

#### 问题点：
1. **Trace ID**
   - 应该从 request header 提取 trace_id 并设置到 context
   - 应该记录请求体大小（用于监控）
   - 应该添加请求 ID 生成（如果没有 trace_id）

### 3.5 安全模块 (`src/security.py`)

#### 问题点：
1. **路径验证**
   - 应该检查路径中是否包含符号链接，防止符号链接攻击
   - 应该检查路径长度限制
   - 应该规范化路径后再检查（处理 //, ./ 等情况）
   - 应该使用更严格的检查，如检查规范化后的路径

### 3.6 数据模型 (`src/models.py`)

#### 问题点：
1. **SkillManifest**
   - 应该添加 `description` 字段用于 Agent 工具描述
   - 应该添加 `version` 字段
   - 应该添加 `author`, `tags` 等元数据字段
   - 应该添加输入/输出 schema 的引用

### 3.7 工具函数 (`src/utils.py`)

#### 问题点：
1. **日志配置**
   - 应该支持日志输出到文件（可配置）
   - 应该支持日志轮转（log rotation）
   - 应该支持 JSON 格式日志（便于日志收集系统）

### 3.8 Runner Factory (`src/runners/__init__.py`)

#### 问题点：
1. **Runner 管理**
   - 应该考虑每个 skill 是否需要独立的 runner 实例
   - 应该支持 runner 的配置（如资源限制）

## 四、优先级建议

### 高优先级（安全和稳定性）
1. ✅ 添加输入验证和请求大小限制
2. ✅ 添加路径安全验证（符号链接、路径规范化）
3. ✅ 添加资源限制（子进程内存、CPU）
4. ✅ 添加输出大小限制
5. ✅ 修复 trace_id 在 middleware 中的使用

### 中优先级（功能和可维护性）
1. ✅ 使用 Pydantic Settings 管理配置
2. ✅ 添加配置验证
3. ✅ 支持 manifest 热重载
4. ✅ 改进错误处理和日志记录
5. ✅ 添加请求限流

### 低优先级（优化和扩展）
1. ✅ 支持对话历史持久化
2. ✅ 添加监控和指标收集
3. ✅ 支持更多 Runner 类型
4. ✅ 改进 Agent 循环控制
5. ✅ 添加单元测试和集成测试

## 五、代码质量建议

1. **类型注解**：补充完整的类型注解
2. **文档字符串**：添加详细的文档字符串
3. **单元测试**：添加单元测试覆盖核心功能
4. **集成测试**：添加集成测试覆盖端到端流程
5. **代码格式化**：使用 black/isort 统一代码格式
6. **静态检查**：使用 mypy 进行类型检查
7. **依赖管理**：固定依赖版本，使用 requirements.txt.lock

## 六、总结

项目整体结构清晰，代码质量良好。主要改进方向：
1. **安全性**：加强输入验证、路径验证、资源限制
2. **可维护性**：改进配置管理、错误处理、日志记录
3. **可扩展性**：支持热重载、动态注册、更多 Runner 类型
4. **性能**：优化缓存、异步处理、资源管理

所有具体的修改点已在代码中用 `@TODO` 注释标记，可以逐步改进。

